### 系统总体功能

**微服务架构**

总入口网关gateway

任务管理服务：任务发起，任务日志，定时任务到时调用任务执行模块服务处理，

任务执行服务：接收任务管理端的执行请求，执行相应任务，支持任务前置条件校验，可以有任务超时报警，任务执行失败重试机制，重试指定次数仍然失败则通知人工干预。任务执行服务，所有任务均交由线程池异步处理，互不干扰。任务类型：调用微服务，执行存储过程，外部http接口，本地方法等等。

消息管理服务：主要用于消息日志监控，消息模板管理，提供发送消息api接口，api接口支持异步以及同步返回。接收到消息请求，进行解析，交由消息推送服务进行具体消息发送。

消息推送服务：接收来自消息管理服务的请求，执行消息推送具体逻辑，支持同步异步。

其他服务：用户登录鉴权，供外部系统调用的消息api提供安全保护等等。





**可视化管理界面**

**任务管理**

1. 任务发起

   				2. 任务执行日志

**消息管理**

1. 消息模板
2. 消息推送日志

**其他基础管理模块**

1. 用户管理
2. API接口鉴权管理



### 核心模块

**任务执行**

1. cron解析，定时执行
2. 任务分类：调用微服务，外部HTTP请求，数据库存储过程，具体方法等等
3. 任务执行前提条件
4. 多任务级联串行执行
5. 任务执行超时处理
6. 任务失败重试机制
7. 任务执行失败告警
8. ...

**消息推送**

1. 消息模板：短信消息模板，邮件消息模板，钉钉消息模板等等
2. 消息类型：短信，邮件，钉钉，电话...



### 简单业务场景分析

1. 每天定时数据跑批监控：

   ​	    每天数据增量同步，同步是否完成，或者因为系统资源，导致同步超时，需要人工干预等等。

2. 每个工作日，产品相关数据钉钉消息推送：

   ​		推送前置条件：是否工作日，增量数据同步是否已完成，查询数据库数据，组装钉钉消息内容，进行推送。

3. 基金估值数据，邮件发送给客户：

   ​		推送前置条件：增量数据同步是否已完成，查询数据库，生成excel文件，发送邮件。

4. OA系统流程通知：

   ​		OA系统流程，某个节点长时间未审批，给相应负责人发送提醒消息进行流程审核。

5. 数仓数据同步，同步异常，需要以电话通知方式通知负责人立马处理。

6. 服务器项目运行异常（服务不可用等等），消息通知。

7. 员工生日祝福短信定时推送



### 定时任务模块设计

**任务管理服务**

1. 任务信息记录数据库，例如任务基本信息，任务调度时间（cron表达式、每隔多少秒一次），下一次执行时间，超时处理策略，失败提醒类型，任务过期策略等等。

2. 任务管理服务启动，启动一个线程，定时扫描数据库任务信息，查询出下一次执行时间小于等于当前时间的任务+5秒，即找到即将要执行并且已经过了执行时间的任务。如果任务已过期5秒，根据过期策略，要么丢弃任务，要么触发一次，然后更新下一次执行时间。如果过期区间在5秒之内，直接执行一次，更新下一次执行时间。剩下的就是即将在5秒之内待执行的任务，将这些任务放到容器中，根据下一次执行时间的秒数等待任务执行，同时更新下一次执行时间。

   另外单独有一个线程，根据当前时间的秒数，执行放到容器中的任务。

   服务可以集群部署，如果有多个服务同时扫描数据库，就会每个服务发起一次任务执行请求，这种情况肯定是不对的。所以需要加入分布式锁，每次只能一个线程读取数据库数据，修改下一次执行时间，这样其他线程读取到的是最新的下一次执行时间，不会重复执行任务。当然也可以根据任务id与本次执行时间为key，在任务执行服务进行幂等校验，如果该任务id与本次执行时间已记录，那么接下来由其他任务管理端发送过来的相同任务，可以不执行，这样做会增加任务执行服务的压力。

3. 任务管理模块，主要核心工作就是扫描待执行的任务，像执行服务发起请求，然后对任务执行的日志进行管理。

4. 任务

**任务执行服务**

1. 接收到任务执行请求，开启线程执行任务。
2. 因为需要支持任务终止及任务执行超时，所以每个请求过来，开启一个Thread，手动终止任务可以执行thread.interrupt()方法，对于任务超时，可以使用FutureTask来判断本次任务是否执行超时。
3. 每个任务，执行结束，都需要将任务执行结果，请求任务管理服务，交由任务管理服务记录日志。



### 一期主要实现功能

1. **项目搭建**

   注册/配置中心：nacos

   任务管理端服务：jobAdmin

   任务执行服务：jobExecute

   消息中心服务：messageCenter

   数据库表设计：任务表，任务日志表

2. **核心功能**

   任务管理端：任务发起、任务停止、任务执行日志

   任务执行端：任务执行，任务执行流程日志

   消息中心：发送消息API接口，消息推送（一阶段可以单服务，后续再考虑消息中间件）

   分布式锁：基于redis

3. **主要流程设计**

   

   